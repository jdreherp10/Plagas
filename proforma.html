<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Proforma Ecuafumi</title>
    <style>
        @media print {
            .no-print { display: none; }
            body { margin: 0; }
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 210mm;
            margin: 0 auto;
            padding: 20px;
        }
        
        .print-button {
            background: #4ab646;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        /* Resto de estilos del PDF */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #2a59a8;
            padding-bottom: 15px;
        }
        
        .logo {
            height: 80px;
        }
        
        .proforma-box {
            border: 2px solid #2a59a8;
            padding: 15px;
            border-radius: 5px;
        }
        
        /* M치s estilos... */
    </style>
</head>
<body>
    <button class="print-button no-print" onclick="window.print()">
        游닌 Descargar PDF
    </button>
    
    <div class="header">
        <img src="https://raw.githubusercontent.com/jdreherp10/Plagas/main/Logo-web-ECUAFUMI.png" class="logo">
        <div class="proforma-box">
            <h2 style="color: #4ab646;">PROFORMA N.췈 <span id="numero">2024-001</span></h2>
            <p>Fecha: <span id="fecha">27/08/2025</span></p>
        </div>
    </div>
    
    <!-- Resto del HTML de la proforma -->
    <script>
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    
    // Funci칩n auxiliar para limpiar y dividir listas de AppSheet
    function parseAppSheetList(param) {
        if (!param || param === '' || param === 'undefined') return [];
        // AppSheet usa " , " como separador
        return param.split(' , ').filter(item => item && item !== '');
    }
    
    // Obtener y parsear las listas
    const nombres = parseAppSheetList(params.get('plagas_nombres'));
    const lugares = parseAppSheetList(params.get('plagas_lugares'));
    const metodos = parseAppSheetList(params.get('plagas_metodos'));
    const precios = parseAppSheetList(params.get('plagas_precios'));
    
    // Si no hay nombres pero s칤 lugares, crear una entrada gen칠rica
    const plagas = [];
    
    if (nombres.length === 0 && lugares.length > 0) {
        // Caso especial: no hay nombres de plagas pero s칤 lugares
        plagas.push({
            nombre: "Control de Plagas General",
            lugares: lugares.join(', '),
            metodos: metodos.join(', ') || "Tratamiento est치ndar",
            precio: parseFloat(precios[0]) || 200
        });
    } else if (nombres.length > 0) {
        // Caso normal: hay nombres de plagas
        for (let i = 0; i < nombres.length; i++) {
            plagas.push({
                nombre: nombres[i],
                lugares: lugares[i] || 'Por definir',
                metodos: metodos[i] || 'Tratamiento est치ndar',
                precio: parseFloat(precios[i]) || 0
            });
        }
    } else {
        // Caso fallback: no hay datos de plagas
        // Intentar crear una entrada 칰nica con todos los lugares
        const todosLugares = params.get('plagas_lugares');
        const todosPrecio = params.get('plagas_precios');
        
        if (todosLugares && todosLugares !== '') {
            plagas.push({
                nombre: "Servicio de Fumigaci칩n",
                lugares: decodeURIComponent(todosLugares).replace(/ , /g, ', '),
                metodos: "Fumigaci칩n y Desratizaci칩n",
                precio: parseFloat(todosPrecio) || 200
            });
        }
    }
    
    // Si a칰n no hay plagas, agregar una por defecto
    if (plagas.length === 0) {
        plagas.push({
            nombre: "Servicio Est치ndar",
            lugares: "Todas las 치reas",
            metodos: "Seg칰n evaluaci칩n",
            precio: 100
        });
    }
    
    return {
        numero: params.get('numero') || '2024-001',
        fecha: params.get('fecha') || new Date().toLocaleDateString('es-EC'),
        clienteNombre: decodeURIComponent(params.get('cliente_nombre') || 'Cliente'),
        clienteRuc: params.get('cliente_ruc') || '',
        clienteAtencion: decodeURIComponent(params.get('cliente_atencion') || ''),
        clienteDireccion: decodeURIComponent(params.get('cliente_direccion') || 'No especificada'),
        clienteTelefono: params.get('cliente_telefono') || 'No especificado',
        clienteEmail: params.get('cliente_email') || 'No especificado',
        proceso: decodeURIComponent(params.get('proceso') || 'Proceso est치ndar'),
        observaciones: decodeURIComponent(params.get('observaciones') || 'Sin observaciones adicionales'),
        firmaNombre: decodeURIComponent(params.get('firma_nombre') || 'Representante'),
        firmaCargo: params.get('firma_cargo') || 'Ejecutivo Comercial',
        formaPago: decodeURIComponent(params.get('forma_pago') || 'Contado'),
        plagas: plagas
    };
}

function fillTemplate() {
    const data = getUrlParams();
    
    // Debug - ver qu칠 datos llegan
    console.log('Datos recibidos:', data);
    
    // Llenar campos simples
    document.getElementById('numero').textContent = data.numero;
    document.getElementById('fecha').textContent = data.fecha;
    document.getElementById('cliente-nombre').textContent = data.clienteNombre;
    document.getElementById('cliente-ruc').textContent = data.clienteRuc;
    document.getElementById('cliente-atencion').textContent = data.clienteAtencion;
    document.getElementById('cliente-direccion').textContent = data.clienteDireccion;
    document.getElementById('cliente-telefono').textContent = data.clienteTelefono;
    document.getElementById('cliente-email').textContent = data.clienteEmail || data.clienteTelefono;
    document.getElementById('proceso').textContent = data.proceso;
    document.getElementById('observaciones').textContent = data.observaciones;
    document.getElementById('firma-nombre').textContent = data.firmaNombre;
    document.getElementById('firma-cargo').textContent = data.firmaCargo;
    
    // Llenar tabla de plagas
    const tbody = document.getElementById('tabla-plagas');
    tbody.innerHTML = ''; // Limpiar tabla
    let subtotal = 0;
    
    data.plagas.forEach(plaga => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${plaga.nombre}</strong></td>
            <td>${plaga.lugares}</td>
            <td>${plaga.metodos}</td>
            <td class="text-right">$${plaga.precio.toFixed(2)}</td>
        `;
        subtotal += plaga.precio;
    });
    
    // Calcular totales
    const iva = subtotal * 0.15;
    const total = subtotal + iva;
    
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('iva').textContent = `$${iva.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;
    
    // Agregar forma de pago si existe
    if (data.formaPago) {
        const totalsDiv = document.querySelector('.totals');
        const formaPagoDiv = document.createElement('div');
        formaPagoDiv.className = 'total-row';
        formaPagoDiv.style.marginTop = '15px';
        formaPagoDiv.style.paddingTop = '10px';
        formaPagoDiv.style.borderTop = '1px solid #ddd';
        formaPagoDiv.innerHTML = `
            <span><strong>Forma de Pago:</strong></span>
            <span>${data.formaPago}</span>
        `;
        totalsDiv.appendChild(formaPagoDiv);
    }
}

// Ejecutar al cargar
window.addEventListener('DOMContentLoaded', fillTemplate);
</script>
</body>
</html>
